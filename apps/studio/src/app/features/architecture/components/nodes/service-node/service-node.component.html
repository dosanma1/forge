<!-- Service Node Card -->
<div
  class="w-[280px] min-w-[240px] max-w-[320px] rounded-lg bg-card shadow-sm overflow-hidden"
  [class]="selected() ? 'border border-primary' : 'border border-border'"
>
  <!-- Node Header -->
  <header
    class="flex items-center justify-between px-3 py-2 bg-blue-50 dark:bg-blue-950/30 border-b border-blue-200 dark:border-blue-800/50 cursor-move"
    dragHandle
  >
    <!-- Target handle on left -->
    <handle
      [id]="'node-' + data()?.id"
      type="target"
      position="left"
      [offsetX]="12"
      [template]="targetHandler.templateRef()"
    />
    <div class="flex items-center gap-2 flex-1 min-w-0">
      <mmc-icon
        name="lucideServer"
        size="sm"
        class="text-blue-500 shrink-0"
      ></mmc-icon>
      <h5
        class="text-sm font-semibold text-foreground tracking-tight truncate text-left"
      >
        {{ data()?.name }}
      </h5>
    </div>
    <mmc-badge
      variant="secondary"
      class="ring-1 text-blue-600 dark:text-blue-400 ring-blue-300 dark:ring-blue-700 bg-blue-100 dark:bg-blue-900/50"
    >
      {{ getLanguageBadge() }}
    </mmc-badge>
  </header>

  <!-- Node Body -->
  <div class="p-3 space-y-2">
    <!-- Root Path -->
    <div class="flex items-start gap-2 text-xs">
      <span class="text-muted-foreground shrink-0">Root:</span>
      <span class="text-foreground font-mono truncate">{{
        data()?.root || 'backend/services/' + data()?.name
      }}</span>
    </div>

    <!-- Deployer -->
    <div class="flex items-center gap-2 text-xs">
      <span class="text-muted-foreground">Deployer:</span>
      <span class="text-foreground">{{ getDeployerLabel() }}</span>
    </div>

    <!-- Tags -->
    <app-node-tags [tags]="data()?.tags ?? []" />

    <!-- HTTP Transports -->
    @for (transport of httpTransports(); track transport.id) {
      <div class="mt-2">
        <!-- Transport Card (AI Transition style) - Clickable -->
        <div
          class="rounded-md border bg-background text-xs overflow-hidden cursor-pointer transition-colors"
          [class]="isTransportSelected(transport.id) ? 'border-primary' : 'border-border/50 hover:border-border'"
          (click)="onTransportClick($event, transport.id)"
        >
          <!-- Header row -->
          <div class="flex items-center gap-2 px-2 py-1.5">
            <mmc-icon name="lucideGlobe" size="xs" class="text-blue-500 shrink-0"></mmc-icon>
            <span class="text-foreground font-medium">HTTP</span>
            <span class="text-muted-foreground">{{ transport.basePath }}</span>
          </div>

          <!-- Endpoints section (inside card) -->
          <div class="border-t border-border/30">
            @for (endpoint of transport.endpoints; track endpoint.id) {
              <div class="flex items-center gap-1.5 px-2 py-1.5 hover:bg-muted/50">
                <app-method-badge [method]="endpoint.method" />
                <span class="text-foreground font-mono truncate">{{ endpoint.path }}</span>
              </div>
            }
            @if (transport.endpoints.length === 0) {
              <div class="px-2 py-1.5 text-muted-foreground italic">No endpoints yet</div>
            }
          </div>
        </div>
      </div>
    }

    <!-- Add Action Button (always visible) -->
    <div class="mt-2 pt-2 border-t border-border/50">
      <button
        class="flex items-center gap-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors"
      >
        <mmc-icon name="lucidePlus" size="xs"></mmc-icon>
        <span>Add action</span>
      </button>
    </div>

    <!-- Source handle at bottom right -->
    <handle
      [id]="'source-' + data()?.id"
      type="source"
      position="right"
      [offsetX]="-12"
      [template]="sourceHandler.templateRef()"
    />
  </div>
</div>

<!-- Handler templates -->
<mmc-handler #targetHandler></mmc-handler>
<mmc-handler #sourceHandler></mmc-handler>
